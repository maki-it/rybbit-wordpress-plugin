name: Release Plugin

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set Version in Plugin File
        shell: bash
        run: |
          set -euo pipefail

          # Tag is like v1.2.3 -> version is 1.2.3
          VERSION="${GITHUB_REF_NAME#v}"

          # Make VERSION available to later steps.
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

          # Replace the whole header line, independent of current version.
          sed -i -E "s/^Version:[[:space:]]*.*/Version: ${VERSION}/" rybbit-analytics/rybbit-analytics.php

          # Assert it worked.
          grep -n -E "^Version:[[:space:]]*${VERSION}$" rybbit-analytics/rybbit-analytics.php

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Fetch stable releases for changelog
        id: changelog
        shell: bash
        run: |
          set -euo pipefail

          # WordPress readme.txt changelog expects headings like:
          # = 1.2.3 =
          # - Change
          # We'll build this from ALL stable (non-prerelease) GitHub releases.
          #
          # NOTE: Not all `gh` versions support `gh release list --json body`.
          # To stay compatible, we:
          #  1) List stable tag names
          #  2) Fetch each release body with `gh release view`.

          CHANGELOG=$(mktemp)

          # Grab stable release tags and keep only semver-ish tags.
          mapfile -t TAGS < <(
            gh release list --limit 200 --exclude-pre-releases --json tagName \
              --jq '.[].tagName | select(test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))'
          )

          for TAG in "${TAGS[@]}"; do
            VERSION=${TAG#v}

            # Fetch body for each release. `--jq` keeps the output plain text.
            BODY=$(gh release view "$TAG" --json body --jq '.body // ""')

            {
              echo "= ${VERSION} ="

              # Turn each non-empty line into a bullet.
              # If a line is already a bullet, keep it as-is.
              echo "$BODY" \
                | sed -e 's/\r$//' \
                | awk 'NF { if ($0 ~ /^[[:space:]]*[-*][[:space:]]+/) { print $0 } else { print "- " $0 } }'

              echo
            } >> "$CHANGELOG"
          done

          # If there are no releases yet, keep changelog non-empty for readme formatting.
          if ! test -s "$CHANGELOG"; then
            echo "= ${GITHUB_REF_NAME#v} =" > "$CHANGELOG"
            echo "- Initial release" >> "$CHANGELOG"
            echo >> "$CHANGELOG"
          fi

          # Export as multiline env var.
          echo "CHANGELOG<<EOF" >> "$GITHUB_ENV"
          cat "$CHANGELOG" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate readme.txt
        shell: bash
        env:
          CHANGELOG: ${{ env.CHANGELOG }}
          VERSION: ${{ env.VERSION }}
        run: |
          cat > rybbit-analytics/readme.txt <<EOF
          === Rybbit Analytics ===
          Contributors: makiit
          Tags: rybbit, analytics, tracking, privacy
          Stable tag: $VERSION
          Requires at least: 5.8
          Tested up to: 6.9
          Requires PHP: 7.4
          License: GPLv3 or later
          License URI: https://github.com/maki-it/rybbit-wordpress-plugin/blob/main/LICENSE
          Add and manage the Rybbit tracking script.
            
          == Description ==
          Add and manage the Rybbit tracking script for WordPress. Configure privacy, role exclusions, and script attributes.

          == Installation ==
          1. Upload and install the Plugin zip archive via the Admin UI or extract the plugin files to the `/wp-content/plugins/rybbit-analytics` directory.
          2. Activate the plugin through the 'Plugins' screen in WordPress.
          3. Configure settings under Settings > Rybbit Analytics.

          == Changelog ==
          EOF
          echo "$CHANGELOG" >> rybbit-analytics/readme.txt
          cat >> rybbit-analytics/readme.txt <<'EOF'
          
          See full changelog at: 
          https://github.com/maki-it/rybbit-wordpress-plugin/releases

          == Frequently Asked Questions ==
          = How do I get my Site ID? =
          Find your Site ID in your Rybbit dashboard under tracking settings.

          == License ==
          GPLv3 or later
          EOF

      - name: Prepare plugin folder
        run: |
          cp LICENSE rybbit-analytics/

      - name: Create plugin zip
        run: |
          zip -r rybbit-analytics.zip rybbit-analytics

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: rybbit-analytics.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
