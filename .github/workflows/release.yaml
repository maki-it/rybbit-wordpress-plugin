name: Release Plugin

on:
  push:
    tags:
      - 'v*'

env:
  CHANGELOG_LIMIT: 10

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set Version in Plugin File
        shell: bash
        run: |
          set -euo pipefail

          # Tag is like v1.2.3 -> version is 1.2.3
          VERSION="${GITHUB_REF_NAME#v}"

          # Make VERSION available to later steps.
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

          # Replace the whole header line, independent of current version.
          sed -i -E "s/^Version:[[:space:]]*.*/Version: ${VERSION}/" rybbit-analytics/rybbit-analytics.php

          # Assert it worked.
          grep -n -E "^Version:[[:space:]]*${VERSION}$" rybbit-analytics/rybbit-analytics.php

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Fetch releases for changelog (fast)
        id: changelog
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # WordPress readme.txt changelog expects headings like:
          # = 1.2.3 =
          # - Change

          CHANGELOG=$(mktemp)

          # Tags we want to include:
          # - stable:     v1.0.0
          # - pre-release v1.0.0-rc.1 (and any other SemVer pre-release/build suffix)
          TAG_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+([+-][0-9A-Za-z.-]+)?$'

          # `--paginate` follows API pagination automatically.
          RELEASES_JSON=$(mktemp)
          gh api --paginate \
            -H "Accept: application/vnd.github+json" \
            "/repos/${GITHUB_REPOSITORY}/releases?per_page=100" \
            --jq '[.[] | {tag_name, body, published_at}]' \
            > "$RELEASES_JSON"

          # Some `gh api --paginate --jq` outputs multiple JSON arrays (one per page).
          # Slurp them into a single array, filter tags, then take only the latest N.
          RELEASES_MERGED=$(mktemp)
          jq -s --arg re "$TAG_REGEX" --argjson n "${CHANGELOG_LIMIT:-20}" 'add | map(select(.tag_name | test($re))) | .[0:$n]' \
            "$RELEASES_JSON" > "$RELEASES_MERGED"

          # Build changelog in the API order (GitHub returns newest first).
          # We use base64 to safely pass multiline bodies and avoid shell/jq escaping issues.
          jq -r '.[] | @base64' "$RELEASES_MERGED" \
            | while IFS= read -r enc; do
                obj=$(printf '%s' "$enc" | base64 -d)
                TAG=$(printf '%s' "$obj" | jq -r '.tag_name')
                BODY=$(printf '%s' "$obj" | jq -r '.body // ""')

                VERSION=${TAG#v}

                {
                  echo "= ${VERSION} ="

                  # Turn each non-empty line into a dash bullet.
                  # - Drop markdown headings like "## What's Changed".
                  # - If a line is already a bullet (either '-' or '*'), normalize it to '-'.
                  echo "$BODY" \
                    | sed -e 's/\r$//' \
                    | awk 'NF {
                        # Skip markdown headings (e.g. "## What\x27s Changed")
                        if ($0 ~ /^[[:space:]]*#{1,6}[[:space:]]+/) next

                        if ($0 ~ /^[[:space:]]*[-*][[:space:]]+/) {
                          sub(/^[[:space:]]*[-*][[:space:]]+/, "- ");
                          print
                        } else {
                          print "- " $0
                        }
                      }'

                  echo
                } >> "$CHANGELOG"
              done

          # If there are no releases yet, keep changelog non-empty for readme formatting.
          if ! test -s "$CHANGELOG"; then
            echo "= ${GITHUB_REF_NAME#v} =" > "$CHANGELOG"
            echo "- Initial release" >> "$CHANGELOG"
            echo >> "$CHANGELOG"
          fi

          # Export as multiline env var.
          echo "CHANGELOG<<EOF" >> "$GITHUB_ENV"
          cat "$CHANGELOG" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Generate readme.txt
        shell: bash
        env:
          CHANGELOG: ${{ env.CHANGELOG }}
          VERSION: ${{ env.VERSION }}
        run: |
          cat > rybbit-analytics/readme.txt <<EOF
          === Rybbit Analytics ===
          Contributors: makiit
          Tags: rybbit, analytics, tracking, privacy
          Stable tag: $VERSION
          Requires at least: 5.8
          Tested up to: 6.9
          Requires PHP: 7.4
          License: GPLv3 or later
          License URI: https://github.com/maki-it/rybbit-wordpress-plugin/blob/main/LICENSE
          Add and manage the Rybbit tracking script.
            
          == Description ==
          Add and manage the Rybbit tracking script for WordPress. Configure privacy, role exclusions, and script attributes.

          == Installation ==
          1. Upload and install the Plugin zip archive via the Admin UI or extract the plugin files to the `/wp-content/plugins/rybbit-analytics` directory.
          2. Activate the plugin through the 'Plugins' screen in WordPress.
          3. Configure settings under Settings > Rybbit Analytics.

          == Changelog ==
          EOF
          echo "$CHANGELOG" >> rybbit-analytics/readme.txt
          cat >> rybbit-analytics/readme.txt <<'EOF'
          
          You can find all releases at: 
          https://github.com/maki-it/rybbit-wordpress-plugin/releases

          == Frequently Asked Questions ==
          = How do I get my Site ID? =
          Find your Site ID in your Rybbit dashboard under tracking settings.

          == License ==
          GPLv3 or later
          EOF

      - name: Prepare plugin folder
        run: |
          cp LICENSE rybbit-analytics/

      - name: Create plugin zip
        run: |
          zip -r rybbit-analytics.zip rybbit-analytics

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: rybbit-analytics.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
